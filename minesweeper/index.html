<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minesweeper</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e2e6ea 100%);
      padding: 20px;
      text-align: center;
      color: #333;
      overflow-x: hidden;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .controls {
      max-width: 600px;
      margin: 0 auto 20px;
    }
    
    .settings {
      margin-bottom: 15px;
    }
    
    .settings label {
      font-weight: 500;
      margin: 0 0.5rem;
    }
    
    .settings input {
      width: 4rem;
      padding: 0.4rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    
    .preset-buttons {
      margin-bottom: 10px;
    }
    
    .preset-buttons button {
      padding: 0.5rem 1rem;
      margin: 0.3rem;
      border: 2px inset #c0c0c0;
      border-radius: 4px;
      background: linear-gradient(145deg, #f0f0f0, #ffffff);
      color: #333;
      font-weight: bold;
      cursor: pointer;
      box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1);
      transition: background 0.3s ease, transform 0.2s;
    }
    .preset-buttons button:hover {
      background: linear-gradient(145deg, #e0e0e0, #f0f0f0);
      transform: translateY(-1px);
    }
    
    .player-section {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .player-section input {
      width: 12rem;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    
    .leaderboard-btn {
      padding: 0.5rem 1rem;
      border: 2px inset #c0c0c0;
      border-radius: 4px;
      background: linear-gradient(145deg, #3498db, #2980b9);
      color: white;
      font-weight: bold;
      cursor: pointer;
      box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1);
      transition: background 0.3s ease, transform 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    
    .leaderboard-btn:hover {
      background: linear-gradient(145deg, #2980b9, #3498db);
      transform: translateY(-1px);
      text-decoration: none;
      color: white;
    }
    
    .game-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .game-wrapper {
      overflow-x: auto;
      max-width: 100%;
    }
    
    .status-container {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    #start {
      font-size: 1.1rem;
      padding: 0.6rem 2rem;
      background: linear-gradient(145deg, #4CAF50, #45a049);
      color: white;
      border: 2px solid #45a049;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    #start:hover {
      background: linear-gradient(145deg, #45a049, #4CAF50);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    .status-item {
      background: linear-gradient(145deg, #f0f0f0, #ffffff);
      border: 2px inset #c0c0c0;
      padding: 8px 12px;
      border-radius: 4px;
      box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1);
      color: #ff0000;
      font-weight: 600;
      font-size: 1rem;
      min-width: 60px;
    }
    
    #game {
      display: inline-block;
      margin: 20px auto;
      border-collapse: collapse;
      border: 2px solid #343a40;
      box-shadow: 6px 6px 16px rgba(0,0,0,0.25);
      border-radius: 6px;
      overflow: hidden;
    }
    
    td {
      width: 32px;
      height: 32px;
      min-width: 32px;
      min-height: 32px;
      max-width: 32px;
      max-height: 32px;
      box-sizing: border-box;
      overflow: hidden;
      white-space: nowrap;
      text-align: center;
      vertical-align: middle;
      font-weight: bold;
      background: linear-gradient(to bottom right, #fdfdfd, #ced4da);
      border: 1px solid #adb5bd;
      cursor: pointer;
      font-size: 1rem;
      /* æœªæ­å¼€æ ¼å­çš„å‡¸èµ·æ•ˆæœ */
      box-shadow: 
        inset 2px 2px 4px rgba(255,255,255,0.8),
        inset -2px -2px 4px rgba(0,0,0,0.2);
      transition: background 0.1s;
    }
    
    td:hover {
      background: linear-gradient(to bottom right, #f8f9fa, #e9ecef);
    }
    
    td.revealed {
      background: #dedede !important; /* æ›´æ·±è‰²ï¼Œä¸”å½»åº•è¦†ç›–æ¸å˜ */
      /* å·²æ­å¼€æ ¼å­çš„å‡¹é™·æ•ˆæœ */
      box-shadow: 
        inset -1px -1px 2px rgba(255,255,255,0.5),
        inset 1px 1px 3px rgba(0,0,0,0.3);
      cursor: default;
    }
    
    td.flag {
      background-color: #ffe4b5;
      color: red;
      box-shadow: 
        inset 2px 2px 4px rgba(255,255,255,0.8),
        inset -2px -2px 4px rgba(0,0,0,0.2);
    }
    
    td.bomb {
      background-color: #f08080;
      color: black;
    }
    
    td.bomb.win {
      background-color: #90ee90 !important;
    }

    td.bomb.lose {
      background-color: #f08080 !important;
    }
    
    td.game-over {
      pointer-events: none;
      opacity: 0.75;
    }
    
    /* ç»å…¸æ‰«é›·æ•°å­—é¢œè‰² */
    .n1 { color: #0000ff; }
    .n2 { color: #008000; }
    .n3 { color: #ff0000; }
    .n4 { color: #000080; }
    .n5 { color: #800000; }
    .n6 { color: #008080; }
    .n7 { color: #000000; }
    .n8 { color: #808080; }
    
    a {
      text-decoration: none;
      color: #007bff;
    }
    a:hover {
      text-decoration: underline;
    }
    
    /* è¸©åˆ°çš„è‡´å‘½é›·ç‰¹æ•ˆ */
    td.fatal-bomb {
      animation: bomb-shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      box-shadow: 0 0 16px 6px #ff0000, 0 0 32px 12px #ffb3b3;
      background: #ff3333 !important;
      color: #fff !important;
      z-index: 2;
      position: relative;
      border: 2px solid #ff0000 !important;
    }
    @keyframes bomb-shake {
      10%, 90% { transform: translateX(-2px); }
      20%, 80% { transform: translateX(4px); }
      30%, 50%, 70% { transform: translateX(-8px); }
      40%, 60% { transform: translateX(8px); }
    }

    /* å…¶ä»–é›·å˜æš— */
    td.dim-bomb {
      opacity: 0.4;
      filter: grayscale(80%);
    }
    
    @media (max-width: 600px) {
      .game-controls {
        flex-direction: column;
        gap: 10px;
      }
      
      .status-container {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .player-section {
        flex-direction: column;
        gap: 10px;
      }
      
      .status-item {
        font-size: 0.9rem;
        padding: 6px 10px;
        min-width: 50px;
      }
    }

    html {
      overflow-y: scroll;
    }
  </style>
</head>
<body>
  <h1>
    Minesweeper v0.2
    <img src="https://yicqi.github.io/images/cats/coco1.jpg" alt="cat" style="height: 60px; vertical-align: middle; margin-left: 10px; border-radius: 6px;" />
  </h1>
  
  <button id="settings-btn" style="position: absolute; top: 20px; left: 20px; z-index: 1000; font-size: 1.2rem; border-radius: 6px; border: none; background: #eee; padding: 8px 16px; cursor: pointer;">âš™ï¸ Settings</button>

  <div class="controls">
    <div class="settings">
      <div class="preset-buttons">
        <button onclick="setDifficulty(9,9,10)">Beginner</button>
        <button onclick="setDifficulty(16,16,40)">Intermediate</button>
        <button onclick="setDifficulty(16,30,99)">Expert</button>
      </div>
      <div>
        <label>Rows: <input type="number" id="rows" value="9" min="1" max="50"></label>
        <label>Cols: <input type="number" id="cols" value="9" min="1" max="50"></label>
        <label>Mines: <input type="number" id="mines" value="10" min="1"></label>
      </div>
    </div>
    
    <div class="player-section">
      <label>Player Name: <input type="text" id="player-name" placeholder="Enter your name" maxlength="20"></label>
      <a href="rank.html" class="leaderboard-btn">ğŸ“ˆ View Leaderboard</a>
    </div>
    
    <div class="game-controls">
      <div class="status-container">
        <div class="status-item">â±ï¸ <span id="timer">0</span>s</div>
        <!-- <div class="status-item">ğŸ‘† <span id="click-count">0</span></div> -->
        <div class="status-item" style="display: none;">ğŸ‘† <span id="click-count">0</span></div>
        <button id="start" onclick="startGame()">ğŸ® Reset Game</button>
        <div class="status-item">ğŸ’£ <span id="mines-left">0</span></div>
      </div>
    </div>
  </div>

  <div class="game-wrapper">
    <table id="game"></table>
  </div>

  <div id="custom-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; box-shadow: 0 6px 18px rgba(0,0,0,0.3);">
      <div id="modal-content"></div>
      <button onclick="closeModal()" style="margin-top: 15px; padding: 8px 16px; border: none; background: #3498db; color: white; border-radius: 6px; cursor: pointer;">OK</button>
    </div>
  </div>

  <div id="settings-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:10001; justify-content:center; align-items:center;">
    <div style="background:white; padding:24px; border-radius:10px; min-width:320px; max-width:90vw; box-shadow:0 6px 18px rgba(0,0,0,0.3);">
      <h2 style="margin-top:0;">Control Settings</h2>
      <div id="settings-content"></div>
      <div style="margin-top:18px; text-align:right;">
        <button id="settings-reset">Restore Default</button>
        <button id="settings-save">Save</button>
        <button id="settings-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <div id="result-info" style="
    margin: 10px auto 0;
    max-width: 600px;
    min-width: 320px;
    width: 100%;
    text-align: center;
    background: linear-gradient(135deg, #f8f9fa 60%, #e2e6ea 100%);
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    padding: 18px 12px 16px 12px;
    min-height: 80px;
    box-sizing: border-box;
  "></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase é…ç½®
    const SUPABASE_URL = 'https://mcrzbhtyagbfeylpfbjw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jcnpiaHR5YWdiZmV5bHBmYmp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTQyNTksImV4cCI6MjA2NzkzMDI1OX0.9_oqTCpTY9W1eo5r9p57PybxekfjTPB2zydVtVtklWg';
    
    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let firstClick = true;
    let board = [], mineSet = new Set();
    let rows = 9, cols = 9, mines = 10;
    let gameOver = false;
    let gameWon = false;

    // è®¡æ—¶å™¨ç›¸å…³å˜é‡
    let timerInterval = null;
    let startTime = 0;
    let timeElapsed = 0;
    let clickCount = 0;
    let flagsCount = 0;

    // ç”¨äºæ£€æµ‹åŒæ—¶æŒ‰ä¸‹å·¦å³é”®çš„å˜é‡
    let mouseButtonState = {
      left: false,
      right: false,
      lastCell: null
    };

    const loseImages = [
      "https://yicqi.github.io/images/cats/putao3.jpg",
      "https://yicqi.github.io/images/cats/putaoyoung.jpg",
      "https://yicqi.github.io/images/cats/putao5.jpg",
      "https://yicqi.github.io/images/cats/coco5.jpg"
    ];

    const winImages = [
      "https://yicqi.github.io/images/cats/coco3.jpg",
      "https://yicqi.github.io/images/cats/putao.jpg",
      "https://yicqi.github.io/images/cats/putao7.jpg",
      "https://yicqi.github.io/images/cats/coco4.jpg"
    ];

    function getRandomImage(images) {
      const index = Math.floor(Math.random() * images.length);
      return images[index];
    }

    function showResultImage(url) {
      const container = document.getElementById("result-image");
      container.innerHTML = `<img src="${url}" style="max-width: 300px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" alt="Result Cat">`;
    }

    function showResultInfo(message, imageUrl) {
      const resultDiv = document.getElementById('result-info');
      resultDiv.innerHTML = `
        <div style="
          font-size: 1.35rem;
          font-weight: 700;
          color: #222;
          margin-bottom: 1rem;
          letter-spacing: 0.02em;
          line-height: 1.3;
          word-break: break-word;
          white-space: normal;
        ">${message}</div>
        <img src="${imageUrl}" style="width: 100%; max-width: 360px; margin: 0 auto; display: block; border-radius: 10px; box-shadow: 0 4px 14px rgba(0,0,0,0.18);" alt="Result Cat">
      `;
    }

    function closeModal() {
      document.getElementById('custom-modal').style.display = 'none';
    }

    async function submitRecord({ player, col, row, mine, click, flags, time }) {
      try {
        console.log('Submitting record:', { player, col, row, mine, click, flags, time });
        
        const { data, error } = await supabase
          .from('minesweeper_records')
          .insert([
            {
              player: player,
              col: col,
              row: row,
              mine: mine,
              click: click,
              flags: flags,
              time: time
            }
          ]);

        if (error) {
          console.error('Error submitting record:', error);
          alert('Failed to submit record. Please try again.');
        } else {
          console.log('Record submitted successfully:', data);
        }
      } catch (error) {
        console.error('Error submitting record:', error);
        alert('Failed to submit record. Please check your internet connection.');
      }
    }

    function setDifficulty(r, c, m) {
      document.getElementById('rows').value = r;
      document.getElementById('cols').value = c;
      document.getElementById('mines').value = m;
    }

    function startGame() {
      rows = parseInt(document.getElementById('rows').value);
      cols = parseInt(document.getElementById('cols').value);
      mines = parseInt(document.getElementById('mines').value);

      if (mines >= rows * cols) {
        alert("Mines must be fewer than total cells!");
        return;
      }

      const game = document.getElementById('game');
      game.innerHTML = '';
      board = [];
      firstClick = true;
      mineSet.clear();
      clickCount = 0;
      flagsCount = 0;
      timeElapsed = 0;
      startTime = 0;
      gameOver = false;
      gameWon = false;
      clearInterval(timerInterval);
      timerInterval = null;
      document.getElementById('timer').innerText = '0';
      document.getElementById('click-count').innerText = '0';
      document.getElementById('mines-left').innerText = mines;
      document.getElementById('result-info').innerHTML = '';

      // æ–°å¢ï¼šæœ‰è¶£æç¤ºè¯­
      const funTips = [
        "How's your luck today?",
        "Watch out for the mines!",
        "They say the first click is always safe!",
        "Can you beat the fastest record?",
        "The more flags you place, the faster your heart beats!",
        "Rumor has it: cats can help you find mines!",
        "Try double-clicking or long-pressing for new actions!",
        "Every click is an adventure!",
        "Good luck, Minesweeper hero!",
        "Sometimes, luck matters more than skill!",
        "Can you clear the board with zero mistakes?",
        "Don't forget to check the leaderboard!",
        "Is the top-left cell really the safest?",
        "Will you become a Minesweeper master?",
        "Cats love safe cells, or so they say!",
      ];
      const tip = funTips[Math.floor(Math.random() * funTips.length)];
      document.getElementById('result-info').innerHTML = `<span style="color:#888;font-size:1.1em;">${tip}</span>`;

      // é‡ç½®é¼ æ ‡çŠ¶æ€
      mouseButtonState = {
        left: false,
        right: false,
        lastCell: null
      };

      for (let r = 0; r < rows; r++) {
        const row = [];
        const tr = document.createElement('tr');
        for (let c = 0; c < cols; c++) {
          const td = document.createElement('td');
          td.dataset.row = r;
          td.dataset.col = c;
          
          // ä½¿ç”¨æ›´æ¸…æ™°çš„äº‹ä»¶å¤„ç†
          td.addEventListener('mousedown', handleMouseDown);
          td.addEventListener('mouseup', handleMouseUp);
          td.addEventListener('contextmenu', e => e.preventDefault());
          
          addLongPressHandler(td, r, c);
          tr.appendChild(td);
          row.push({ revealed: false, mine: false, flag: false, number: 0 });
        }
        board.push(row);
        game.appendChild(tr);
      }
    }

    function handleMouseDown(e) {
      if (gameOver) return; // æ¸¸æˆç»“æŸåé˜»æ­¢æ‰€æœ‰æ“ä½œ
      
      const r = parseInt(this.dataset.row);
      const c = parseInt(this.dataset.col);
      
      // è®°å½•æŒ‰ä¸‹çš„æŒ‰é’®
      if (e.button === 0) mouseButtonState.left = true;
      if (e.button === 2) mouseButtonState.right = true;
      
      mouseButtonState.lastCell = { row: r, col: c, element: this };
      
      e.preventDefault();
    }

    function handleMouseUp(e) {
      if (gameOver) return;
      const r = parseInt(this.dataset.row);
      const c = parseInt(this.dataset.col);
      const cell = board[r][c];

      const s = controlSettings.desktop;

      // åˆ¤æ–­å½“å‰æ“ä½œ
      let op = null;
      if (e.button === 0) op = 'left';
      else if (e.button === 2) op = 'right';
      else if (e.button === 1) op = 'middle';
      // both: åŒæ—¶æŒ‰ä¸‹å·¦å³é”®
      let isBoth = mouseButtonState.left && mouseButtonState.right;

      // Chord
      if ((s.chord.includes(op) && cell.revealed) || (isBoth && s.chord.includes('both') && cell.revealed)) {
        clickCount++;
        updateClickDisplay();
        chordReveal(r, c);
        checkWin();
      }
      // Flag
      else if (s.flag === op && !cell.revealed) {
        toggleFlag(this, r, c);
        checkWin();
      }
      // Open
      else if (s.open === op && !cell.revealed && !cell.flag) {
        clickCount++;
        updateClickDisplay();
        if (firstClick) {
          placeMines(r, c);
          firstClick = false;
          startTimer();
        }
        reveal(r, c);
        checkWin();
      }

      if (e.button === 0) mouseButtonState.left = false;
      if (e.button === 2) mouseButtonState.right = false;
      e.preventDefault();
    }

    function placeMines(excludeR, excludeC) {
      while (mineSet.size < mines) {
        const r = Math.floor(Math.random() * rows);
        const c = Math.floor(Math.random() * cols);
        if (r === excludeR && c === excludeC) continue;
        const key = `${r},${c}`;
        if (!mineSet.has(key)) {
          mineSet.add(key);
          board[r][c].mine = true;
        }
      }

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (board[r][c].mine) continue;
          let count = 0;
          for (let dr = -1; dr <= 1; dr++) {
            for (let dc = -1; dc <= 1; dc++) {
              const nr = r + dr, nc = c + dc;
              if (nr >= 0 && nr < rows && nc >= 0 && nc < cols) {
                if (mineSet.has(`${nr},${nc}`)) count++;
              }
            }
          }
          board[r][c].number = count;
        }
      }
    }

    function updateClickDisplay() {
      document.getElementById('click-count').innerText = clickCount;
    }

    function chordReveal(r, c) {
      const cell = board[r][c];
      if (!cell.revealed || cell.number === 0) return;

      let flaggedNeighbors = 0;
      for (let dr = -1; dr <= 1; dr++) {
        for (let dc = -1; dc <= 1; dc++) {
          if (dr === 0 && dc === 0) continue;
          const nr = r + dr, nc = c + dc;
          if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && board[nr][nc].flag) {
            flaggedNeighbors++;
          }
        }
      }

      if (flaggedNeighbors === cell.number) {
        for (let dr = -1; dr <= 1; dr++) {
          for (let dc = -1; dc <= 1; dc++) {
            if (dr === 0 && dc === 0) continue;
            const nr = r + dr, nc = c + dc;
            reveal(nr, nc);
          }
        }
      }
    }

    function toggleFlag(cell, r, c) {
      if (board[r][c].revealed) return;
      
      const wasFlag = board[r][c].flag;
      board[r][c].flag = !wasFlag;
      cell.classList.toggle('flag');
      cell.innerText = board[r][c].flag ? 'ğŸš©' : '';
      
      // æ›´æ–° flagsCount
      if (board[r][c].flag) {
        flagsCount++;
      } else {
        flagsCount--;
      }
      
      document.getElementById('mines-left').innerText = mines - flagsCount;
      console.log('Flag toggled. Current flagsCount:', flagsCount); // Debug log
    }

    function reveal(r, c) {
      if (r < 0 || r >= rows || c < 0 || c >= cols) return;
      const cell = board[r][c];
      const td = document.querySelector(`td[data-row="${r}"][data-col="${c}"]`);
      if (cell.revealed || cell.flag) return;

      cell.revealed = true;
      td.classList.add('revealed');

      if (cell.mine) {
        td.classList.add('bomb', 'fatal-bomb');
        td.innerText = 'ğŸ’£';
        // è®°å½•è‡´å‘½é›·åæ ‡
        window.fatalBomb = { r, c };
        gameOver = true;
        lockGame();
        vibrate(200);
        showResultInfo('ğŸ’¥ Boom! Game Over. Click Reset to play again.', getRandomImage(loseImages));
        revealAllMines(); // è¾“äº†æ­éœ²æ‰€æœ‰
        clearInterval(timerInterval);
        timerInterval = null;
        return;
      }

      if (cell.number > 0) {
        td.innerText = cell.number;
        td.classList.add('n' + cell.number);
      } else {
        for (let dr = -1; dr <= 1; dr++) {
          for (let dc = -1; dc <= 1; dc++) {
            if (dr !== 0 || dc !== 0) {
              reveal(r + dr, c + dc);
            }
          }
        }
      }
    }

    function lockGame() {
      // é”å®šæ‰€æœ‰æ ¼å­ï¼Œç¦æ­¢è¿›ä¸€æ­¥æ“ä½œ
      const allCells = document.querySelectorAll('#game td');
      allCells.forEach(cell => {
        cell.classList.add('game-over');
      });
    }

    function revealAllMines() {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const cell = board[r][c];
          const td = document.querySelector(`td[data-row="${r}"][data-col="${c}"]`);
          if (!cell.revealed) {
            cell.revealed = true;
            td.classList.add('revealed');
          }
          if (cell.mine) {
            if (!cell.flag) {
              // åˆ¤æ–­æ˜¯ä¸æ˜¯è‡´å‘½é›·
              if (window.fatalBomb && window.fatalBomb.r === r && window.fatalBomb.c === c) {
                td.classList.add('bomb', 'lose', 'fatal-bomb');
                td.innerText = 'ğŸ’£';
              } else {
                td.classList.add('bomb', 'lose', 'dim-bomb');
                td.innerText = 'ğŸ’£';
              }
            } else {
              td.classList.add('bomb', 'dim-bomb');
              td.innerText = 'ğŸš©';
            }
          } else if (cell.number > 0) {
            td.innerText = cell.number;
            td.classList.add('n' + cell.number);
          }
        }
      }
    }

    function revealAllCells() {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const cell = board[r][c];
          const td = document.querySelector(`td[data-row="${r}"][data-col="${c}"]`);
          
          if (!cell.revealed) {
            cell.revealed = true;
            td.classList.add('revealed');
            
            if (cell.mine) {
              td.classList.add('bomb', 'win');  // æ·»åŠ  .win ç±»
              td.innerText = 'ğŸ’£';
            } else if (cell.number > 0) {
              td.innerText = cell.number;
              td.classList.add('n' + cell.number);
            }
          }
        }
      }
    }


    function startTimer() {
      if (timerInterval) return;
      startTime = Date.now();
      timerInterval = setInterval(() => {
        timeElapsed = Math.floor((Date.now() - startTime) / 1000);
        // é™åˆ¶æ˜¾ç¤ºæœ€å¤§999ç§’
        const displayTime = Math.min(timeElapsed, 999);
        document.getElementById('timer').innerText = displayTime;
      }, 100); // æ›´æ–°é¢‘ç‡æé«˜åˆ°100msï¼Œæ˜¾ç¤ºæ›´å¹³æ»‘
    }

    async function checkWin() {
      let revealedCount = 0;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (board[r][c].revealed) revealedCount++;
        }
      }
    
      if (revealedCount === rows * cols - mines) {
        // è®¡ç®—ç²¾ç¡®çš„å®Œæˆæ—¶é—´ï¼ˆåŒ…å«å°æ•°ï¼‰
        const finalTime = startTime > 0 ? (Date.now() - startTime) / 1000 : 0;
        
        gameWon = true;
        gameOver = true;
        vibrate([100, 50, 100]); // æ¸¸æˆèƒœåˆ©éœ‡åŠ¨åé¦ˆ - éœ‡åŠ¨æ¨¡å¼
        clearInterval(timerInterval);
        timerInterval = null;
      
        // åŒé‡æ£€æŸ¥flagæ•°é‡
        let actualFlagsFromBoard = 0;
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (board[r][c].flag) actualFlagsFromBoard++;
          }
        }
        
        console.log('Debug info before win:');
        console.log('flagsCount variable:', flagsCount);
        console.log('DOM mines-left display:', document.getElementById('mines-left').innerText);
        
        // æ­éœ²æ‰€æœ‰æ ¼å­
        revealAllCells();
        
        // è·å–ç©å®¶å
        const playerNameInput = document.getElementById('player-name');
        let playerName = playerNameInput.value.trim();
        
        if (!playerName) {
          playerName = prompt("ğŸ‰ Enter your name:");
        }
        
        if (playerName) {
          const finalData = {
            player: playerName,
            col: cols,
            row: rows,
            mine: mines,
            click: clickCount,
            flags: flagsCount,
            time: parseFloat(finalTime.toFixed(3))
          };
          
          console.log('Win! Final data being sent:', finalData);
          await submitRecord(finalData);
        }
      
        showResultInfo(
          `ğŸ‰ You Win!<br>Time: ${finalTime.toFixed(3)}s<br>Clicks: ${clickCount}<br>Flags: ${actualFlagsFromBoard}<br><br>Click Reset to play again.`,
          getRandomImage(winImages)
        );
      }
    }

    // éœ‡åŠ¨åé¦ˆå‡½æ•°
    function vibrate(duration = 50) {
      if (!controlSettings.vibration) return;
      
      if ('vibrate' in navigator) {
        navigator.vibrate(duration);
      }
    }

    function addLongPressHandler(td, r, c) {
      let pressTimer = null;
      let tapCount = 0;
      let tapTimer = null;
      let longPressTriggered = false;
      let touchStartTime = 0;
      let touchStartPos = { x: 0, y: 0 };
      

    
      // é•¿æŒ‰æ ‡è®°æ——å¸œ
      td.addEventListener('touchstart', e => {
        if (gameOver) return; // æ¸¸æˆç»“æŸåé˜»æ­¢æ‰€æœ‰æ“ä½œ
        
        e.preventDefault();
        longPressTriggered = false;
        touchStartTime = Date.now();
        touchStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        
        pressTimer = setTimeout(() => {
          if (tapCount === 0 && !longPressTriggered) { // åªæœ‰å•æ¬¡è§¦æ‘¸ä¸”æœªè§¦å‘é•¿æŒ‰æ‰æ ‡è®°æ——å¸œ
            longPressTriggered = true;
            if (controlSettings.mobile.flag === 'long') {
              vibrate(100); // é•¿æŒ‰éœ‡åŠ¨åé¦ˆ
              toggleFlag(td, r, c);
              checkWin();
            }
          }
        }, 500);
      });
    
      td.addEventListener('touchend', e => {
        if (gameOver) return; // æ¸¸æˆç»“æŸåé˜»æ­¢æ‰€æœ‰æ“ä½œ
        
        clearTimeout(pressTimer);
        
        // æ£€æŸ¥æ˜¯å¦ç§»åŠ¨å¤ªå¤šï¼Œå¦‚æœæ˜¯åˆ™å–æ¶ˆæ“ä½œ
        const touchEndPos = { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
        const moveDistance = Math.sqrt(
          Math.pow(touchEndPos.x - touchStartPos.x, 2) + 
          Math.pow(touchEndPos.y - touchStartPos.y, 2)
        );
        
        if (moveDistance > 10) { // ç§»åŠ¨è¶…è¿‡10pxåˆ™å–æ¶ˆ
          clearTimeout(tapTimer);
          tapCount = 0;
          return;
        }
        
        // å¦‚æœé•¿æŒ‰å·²è§¦å‘ï¼Œä¸å¤„ç†å•å‡»/åŒå‡»
        if (longPressTriggered) {
          tapCount = 0;
          return;
        }
        
        // åŒå‡»æ£€æµ‹ï¼ˆç”¨äºç§»åŠ¨è®¾å¤‡çš„å’Œå¼¦æ“ä½œï¼‰
        tapCount++;
        if (tapCount === 1) {
          tapTimer = setTimeout(() => {
            // å•å‡»å¤„ç† - å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…ä¸åŒå‡»å†²çª
            if (controlSettings.mobile.open === 'tap' && !board[r][c].flag) {
              vibrate(30); // å•å‡»éœ‡åŠ¨åé¦ˆ
              clickCount++;
              updateClickDisplay();
              if (firstClick) {
                placeMines(r, c);
                firstClick = false;
                startTimer();
              }
              reveal(r, c);
              checkWin();
            }
            tapCount = 0;
          }, 200); // å‡å°‘å»¶è¿Ÿæ—¶é—´ï¼Œæé«˜å“åº”æ€§
        } else if (tapCount === 2) {
          // åŒå‡»å¤„ç†
          clearTimeout(tapTimer);
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯åŒå‡»æ ‡è®°æ——å¸œ
          if (controlSettings.mobile.flag === 'double' && !board[r][c].revealed) {
            vibrate(50); // åŒå‡»æ ‡è®°éœ‡åŠ¨åé¦ˆ
            toggleFlag(td, r, c);
            checkWin();
          }
          // æ£€æŸ¥æ˜¯å¦æ˜¯åŒå‡»å’Œå¼¦æ“ä½œ
          else if (controlSettings.mobile.chord.includes('double') && board[r][c].revealed) {
            vibrate(50); // åŒå‡»å’Œå¼¦éœ‡åŠ¨åé¦ˆ
            clickCount++;
            updateClickDisplay();
            chordReveal(r, c);
            checkWin();
          }
          tapCount = 0;
        }
      });
    
      td.addEventListener('touchmove', e => {
        clearTimeout(pressTimer);
        clearTimeout(tapTimer);
        tapCount = 0;
        longPressTriggered = false;
      });
      
      // æ·»åŠ è§¦æ‘¸å–æ¶ˆäº‹ä»¶å¤„ç†
      td.addEventListener('touchcancel', e => {
        clearTimeout(pressTimer);
        clearTimeout(tapTimer);
        tapCount = 0;
        longPressTriggered = false;
      });
    }

    // å…¨å±€é¼ æ ‡äº‹ä»¶ç›‘å¬ï¼Œç”¨äºå¤„ç†åœ¨æ ¼å­å¤–é‡Šæ”¾é¼ æ ‡çš„æƒ…å†µ
    document.addEventListener('mouseup', () => {
      mouseButtonState = { left: false, right: false, lastCell: null };
    });

    document.addEventListener('contextmenu', e => e.preventDefault());
    
    window.onload = startGame;

    // ========== æ“ä½œè®¾ç½®ç›¸å…³ ==========
    const defaultSettings = {
      desktop: {
        open: 'left',
        flag: 'right',
        chord: ['middle', 'both']
      },
      mobile: {
        open: 'tap',
        flag: 'long',
        chord: ['double']
      },
      vibration: true
    };

    function loadSettings() {
      try {
        const s = localStorage.getItem('minesweeper_control_settings');
        if (!s) return JSON.parse(JSON.stringify(defaultSettings));
        return JSON.parse(s);
      } catch {
        return JSON.parse(JSON.stringify(defaultSettings));
      }
    }
    function saveSettings(settings) {
      localStorage.setItem('minesweeper_control_settings', JSON.stringify(settings));
    }

    let controlSettings = loadSettings();

    function renderSettingsUI() {
      const s = controlSettings;
      // ç”µè„‘ç«¯
      let desktopOps = ['left', 'right', 'middle', 'both'];
      let desktopLabels = {
        left: 'Left Click',
        right: 'Right Click',
        middle: 'Middle Click',
        both: 'Left+Right'
      };
      let mobileOps = ['tap', 'long', 'double'];
      let mobileLabels = {
        tap: 'Tap',
        long: 'Long Press',
        double: 'Double Tap'
      };

      let html = `<h3>PC Controls</h3>
        <div>
          <b>Open cell:</b><br>
          ${desktopOps.map(op =>
            `<label><input type="radio" name="desktop-open" value="${op}" ${s.desktop.open===op?'checked':''}>${desktopLabels[op]}</label>`
          ).join(' ')}
        </div>
        <div>
          <b>Flag mine:</b><br>
          ${desktopOps.map(op =>
            `<label><input type="radio" name="desktop-flag" value="${op}" ${s.desktop.flag===op?'checked':''}>${desktopLabels[op]}</label>`
          ).join(' ')}
        </div>
        <div>
          <b>Chord (multi-select):</b><br>
          ${desktopOps.map(op =>
            `<label><input type="checkbox" name="desktop-chord" value="${op}" ${s.desktop.chord.includes(op)?'checked':''}>${desktopLabels[op]}</label>`
          ).join(' ')}
        </div>
        <hr>
        <h3>Mobile Controls</h3>
        <div>
          <b>Open cell:</b><br>
          ${mobileOps.map(op =>
            `<label><input type="radio" name="mobile-open" value="${op}" ${s.mobile.open===op?'checked':''}>${mobileLabels[op]}</label>`
          ).join(' ')}
        </div>
        <div>
          <b>Flag mine:</b><br>
          ${mobileOps.map(op =>
            `<label><input type="radio" name="mobile-flag" value="${op}" ${s.mobile.flag===op?'checked':''}>${mobileLabels[op]}</label>`
          ).join(' ')}
        </div>
        <div>
          <b>Chord (multi-select):</b><br>
          ${mobileOps.map(op =>
            `<label><input type="checkbox" name="mobile-chord" value="${op}" ${s.mobile.chord.includes(op)?'checked':''}>${mobileLabels[op]}</label>`
          ).join(' ')}
        </div>
        <hr>
        <h3>Feedback Settings</h3>
        <div>
          <label><input type="checkbox" name="vibration" ${s.vibration?'checked':''}> Enable vibration feedback</label>
        </div>
        <div style="color:#888;font-size:0.95em;margin-top:8px;">Open and Flag cannot be the same. Chord can be any combination.</div>
      `;
      document.getElementById('settings-content').innerHTML = html;

      // äº’æ–¥é€»è¾‘
      document.querySelectorAll('input[name="desktop-open"]').forEach(el => {
        el.onchange = function() {
          controlSettings.desktop.open = this.value;
          if (controlSettings.desktop.flag === this.value) {
            // è‡ªåŠ¨åˆ‡æ¢flagåˆ°ç¬¬ä¸€ä¸ªä¸åŒçš„
            controlSettings.desktop.flag = desktopOps.find(op => op !== this.value);
          }
          renderSettingsUI();
        };
      });
      document.querySelectorAll('input[name="desktop-flag"]').forEach(el => {
        el.onchange = function() {
          controlSettings.desktop.flag = this.value;
          if (controlSettings.desktop.open === this.value) {
            controlSettings.desktop.open = desktopOps.find(op => op !== this.value);
          }
          renderSettingsUI();
        };
      });
      document.querySelectorAll('input[name="desktop-chord"]').forEach(el => {
        el.onchange = function() {
          if (this.checked) {
            if (!controlSettings.desktop.chord.includes(this.value)) controlSettings.desktop.chord.push(this.value);
          } else {
            controlSettings.desktop.chord = controlSettings.desktop.chord.filter(x=>x!==this.value);
          }
        };
      });

      document.querySelectorAll('input[name="mobile-open"]').forEach(el => {
        el.onchange = function() {
          controlSettings.mobile.open = this.value;
          if (controlSettings.mobile.flag === this.value) {
            controlSettings.mobile.flag = mobileOps.find(op => op !== this.value);
          }
          renderSettingsUI();
        };
      });
      document.querySelectorAll('input[name="mobile-flag"]').forEach(el => {
        el.onchange = function() {
          controlSettings.mobile.flag = this.value;
          if (controlSettings.mobile.open === this.value) {
            controlSettings.mobile.open = mobileOps.find(op => op !== this.value);
          }
          renderSettingsUI();
        };
      });
      document.querySelectorAll('input[name="mobile-chord"]').forEach(el => {
        el.onchange = function() {
          if (this.checked) {
            if (!controlSettings.mobile.chord.includes(this.value)) controlSettings.mobile.chord.push(this.value);
          } else {
            controlSettings.mobile.chord = controlSettings.mobile.chord.filter(x=>x!==this.value);
          }
        };
      });
      
      // éœ‡åŠ¨è®¾ç½®
      document.querySelectorAll('input[name="vibration"]').forEach(el => {
        el.onchange = function() {
          controlSettings.vibration = this.checked;
        };
      });
    }

    // æ‰“å¼€è®¾ç½®æ—¶æ¸²æŸ“
    document.getElementById('settings-btn').onclick = function() {
      renderSettingsUI();
      document.getElementById('settings-modal').style.display = 'flex';
    };
    document.getElementById('settings-cancel').onclick = function() {
      document.getElementById('settings-modal').style.display = 'none';
    };
    document.getElementById('settings-save').onclick = function() {
      saveSettings(controlSettings);
      document.getElementById('settings-modal').style.display = 'none';
    };
    document.getElementById('settings-reset').onclick = function() {
      controlSettings = JSON.parse(JSON.stringify(defaultSettings));
      renderSettingsUI();
    };
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.getElementById('settings-modal').addEventListener('click', function(e) {
      if (e.target === this) this.style.display = 'none';
    });
  </script>
</body>
</html>
